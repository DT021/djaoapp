{% extends "saas/base_dashboard.html" %}

{% block saas_title %}
Subscriptions to {{organization.printable_name}}
{% endblock %}

{% block saas_content %}
<section id="subscribers">
<div id="subscribers-list-container" data-trip data-trip-index="1" data-trip-content="<h2>Active Subscribers</h2><p>List of all active subscribers.<br />You will find here the list of all active subscribers,<br />with the plans they are subscribed to, the date they first<br />subscribed as well as when their renewal is due.</p><em>Use keyboard navigation or click 'Next' to move forward.</em>" data-trip-position="screen-center">
    <tabs v-model="currentTab" :transition-duration="0" @change="tabChanged">
        {% if registered %}
        <tab title="Registered">
            <div style="margin-top:10px;margin-bottom:10px;">
                <label>Filter</label> <input type="text" class="form-control" v-model="params.q" @input="filterList" />
                <a id="download-registered" :href="'{{registered.urls.download}}?q=' + params.q" class="btn btn-default pull-right" role="button"><i class="fa fa-cloud-download"></i> CSV Download</a>
            </div>
            <div class="table-responsive">
            <table class="table table-condensed table-striped" style="width:100%">
                <thead>
                    <tr>
                        <th>Full name</th>
                        <th class="text-right">
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-show="!registered.loaded">
                        <td colspan="2">
                            <h3  class="text-center"><i class="fa fa-refresh fa-spin fa-2x"></i></h3>
                        </td>
                    </tr>
                    <tr v-show="registered.loaded && registered.count == 0">
                        <td colspan="2">
                            <h4 class="text-center"><em>No registered users<span v-show="params.q"> [[params.q]]</span></em></h4>
                        </td>
                    </tr>
                </tbody>
                <tbody class="has-results" v-for="entry in registered.results" v-cloak v-show="registered.loaded && registered.results.length > 0">
                    <tr>
                        <td>
                            <a :href="'{{urls.user.profile_redirect}}' + entry.slug + '/'">[[entry.full_name]]</a>
                        </td>
                        <td>
                        [[entry.created_at | relativeDate]]
                        </td>
                    </tr>
                </tbody>
            </table>
            </div>
            <div class="text-center" v-show="registered.loaded && totalItems > itemsPerPage">
                <uiv-pagination v-model="params.page" :total-page="pageCount" @change="get" boundary-links/>
            </div>
        </tab>
        {% endif %}


        {% for tab in tabs %}
        <tab id="{{tab.slug}}" class="tab-pane{% if tab.is_active %} active{% endif %}" role="tabpanel">
          <div style="margin-top:10px;margin-bottom:10px;">
            <input type="text" class="form-control filter-inline"
                placeholder="Filter"
                ng-model="filterExpr" ng-change="filterList(filterExpr)"
                v-model="params.q" @input="filterList" />
            <a id="download-{{tab.slug}}"
               class="btn btn-default pull-right" role="button"
               href="{{tab.urls.download}}?q=[[filterExpr]]"
               :href="'{{tab.urls.download}}?q=' + params.q"><i class="fa fa-cloud-download"></i> CSV Download</a>
          </div>
          <div class="table-responsive">
            <table class="table table-condensed table-striped">
    <thead>
      <tr ng-show="params.o === 'organization'"
          v-show="params.o === 'organization'">
        <th>Subscriber
            <button class="btn-link btn-sort"
              ng-click="sortBy('organization')"
              @click="sortBy('organization')">
              <i class="fa fa-sort[[(params.o === 'organization') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('organization')"></i>
            </button>
        </th>
        <th>Plan
            <button class="btn-link btn-sort"
              ng-click="sortBy('plan')"
              @click="sortBy('plan')">
              <i class="fa fa-sort[[(params.o === 'plan') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('plan')"></i>
            </button>
        </th>
        <th>Since
            <button class="btn-link btn-sort"
              ng-click="sortBy('created_at')"
              @click="sortBy('created_at')">
              <i class="fa fa-sort[[(params.o === 'created_at') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('created_at')"></i>
            </button>
        </th>
        <th>Ends At
            <button class="btn-link btn-sort"
              ng-click="sortBy('ends_at')"
              @click="sortBy('ends_at')">
              <i class="fa fa-sort[[(params.o === 'ends_at') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('ends_at')"></i>
            </button>
        </th>
        <th>Description</th>
      </tr>
      <tr ng-show="params.o === 'plan'"
          v-show="params.o === 'plan'">
        <th>Plan
            <button class="btn-link btn-sort"
              ng-click="sortBy('plan')"
              @click="sortBy('plan')">
              <i class="fa fa-sort[[(params.o === 'plan') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('plan')"></i>
            </button>
        </th>
        <th>Subscriber
            <button class="btn-link btn-sort"
              ng-click="sortBy('organization')"
              @click="sortBy('organization')">
              <i class="fa fa-sort[[(params.o === 'organization') ? ('-' + (params.o === 'organization')) : '']]"
                 :class="sortIcon('organization')"></i>
            </button>
        </th>
        <th>Since
            <button class="btn-link btn-sort"
              ng-click="sortBy('created_at')"
              @click="sortBy('created_at')">
              <i class="fa fa-sort[[(params.o === 'created_at') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('created_at')"></i>
            </button>
        </th>
        <th>Ends At
            <button class="btn-link btn-sort"
              ng-click="sortBy('ends_at')"
              @click="sortBy('ends_at')">
              <i class="fa fa-sort[[(params.o === 'ends_at') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('ends_at')"></i>
            </button>
        </th>
        <th>Description</th>
      </tr>
      <tr ng-show="params.o === 'created_at'"
         v-show="params.o === 'created_at'">
        <th>Since
            <button class="btn-link btn-sort"
              ng-click="sortBy('created_at')"
              @click="sortBy('created_at')">
              <i class="fa fa-sort[[(params.o === 'created_at') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('created_at')"></i>
            </button>
        </th>
        <th>Subscriber
            <button class="btn-link btn-sort"
              ng-click="sortBy('organization')"
              @click="sortBy('organization')">
              <i class="fa fa-sort[[(params.o === 'organization') ? ('-' + (params.o === 'organization')) : '']]"
                 :class="sortIcon('organization')"></i>
            </button>
        </th>
        <th>Plan
            <button class="btn-link btn-sort"
              ng-click="sortBy('plan')"
              @click="sortBy('plan')">
              <i class="fa fa-sort[[(params.o === 'plan') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('plan')"></i>
            </button>
        </th>
        <th>Ends At
            <button class="btn-link btn-sort"
              ng-click="sortBy('ends_at')"
              @click="sortBy('ends_at')">
              <i class="fa fa-sort[[(params.o === 'ends_at') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('ends_at')"></i>
            </button>
        </th>
        <th>Description</th>
      </tr>
      <tr ng-show="params.o === 'ends_at'"
         v-show="params.o === 'ends_at'">
        <th>Ends At
            <button class="btn-link btn-sort"
              ng-click="sortBy('ends_at')"
              @click="sortBy('ends_at')">
              <i class="fa fa-sort[[(params.o === 'ends_at') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('ends_at')"></i>
            </button>
        </th>
        <th>Subscriber
            <button class="btn-link btn-sort"
              ng-click="sortBy('organization')"
              @click="sortBy('organization')">
              <i class="fa fa-sort[[(params.o === 'organization') ? ('-' + (params.o === 'organization')) : '']]"
                 :class="sortIcon('organization')"></i>
            </button>
        </th>
        <th>Plan
            <button class="btn-link btn-sort"
              ng-click="sortBy('plan')"
              @click="sortBy('plan')">
              <i class="fa fa-sort[[(params.o === 'plan') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('plan')"></i>
            </button>
        </th>
        <th>Since
            <button class="btn-link btn-sort"
              ng-click="sortBy('created_at')"
              @click="sortBy('created_at')">
              <i class="fa fa-sort[[(params.o === 'created_at') ? ('-' + params.ot) : '']]"
                 :class="sortIcon('created_at')"></i>
            </button>
        </th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody class="fetching-results"
           ng-show="!{{tab.slug}}.$resolved"
           v-show="!{{tab.slug}}.loaded">
      <tr>
        <td colspan="5">
          <h3  class="text-center"><i class="fa fa-refresh fa-spin fa-2x"></i></h3>
        </td>
      </tr>
    </tbody>
    <tbody class="has-no-results"
           ng-show="{{tab.slug}}.$resolved && {{tab.slug}}.results.length == 0"
           v-show="{{tab.slug}}.loaded && {{tab.slug}}.results.length == 0">
      <tr>
        <td colspan="5">
          <h4 class="text-center">
            <em>No subscribers
              <span ng-show="filterExpr"
                    v-show="params.q"> with filter: '[[params.q]]'</span>
            </em>
          </h4>
        </td>
      </tr>
    </tbody>
    <tbody ng-repeat="entry in {{tab.slug}}.results | groupBy:['organization.printable_name']"
           ng-show="params.o === 'organization' && {{tab.slug}}.$resolved && {{tab.slug}}.results.length > 0" ng-cloak
           v-for="(group, key) in groupBy({{tab.slug}}.results, 'organization.printable_name')"
           v-show="params.o === 'organization' && {{tab.slug}}.loaded && {{tab.slug}}.results.length > 0" v-cloak>
      <tr ng-show="entry.organization_printable_name_CHANGED">
        <td colspan="5">
          <a id="[[entry.organization.slug]]" href="{{urls.organization.profile_base}}[[entry.organization.slug]]/subscriptions/">[[entry.organization.printable_name]]</a></td>
      </tr>
      <tr ng-class="endsSoon(entry)">
        <td></td>
        <td>[[entry.plan.title]]</td>
        <td>[[entry.created_at | date: mediumDate]]</td>
        <td>[[entry.ends_at |date: mediumDate]]</td>
        <td id="[[entry.id]]" class="description editable">
            <span ng-hide="entry.editDescription"
                  ng-click="editDescription($event, entry)">[[entry.description]] <i class="fa fa-pencil"></i></span>
            <input ng-show="entry.editDescription" type="text"
                   class="form-control"
                   ng-blur="saveDescription($event, entry)"
                   ng-model="entry.description"
                   tooltip="Edit description here"
                   tooltip-trigger="focus"
                   tooltip-placement="top">
        </td>
      </tr>
    </tbody>
    <tbody ng-repeat="entry in {{tab.slug}}.results | groupBy:['plan.title']"
           ng-show="params.o === 'plan'" ng-cloak
           v-for="(group, key) in groupBy({{tab.slug}}.results, 'plan.title')"
           v-show="params.o === 'plan'" v-cloak>
        <tr ng-show="entry.plan_title_CHANGED">
            <td colspan="5">
                [[group[0].plan.title]]
            </td>
        </tr>
        <tr v-for="entry in group" :class="endsSoon(entry)">
            <td></td>
            <td>
                <a :href="'{{urls.organization.profile_base}}' + entry.organization.slug + '/subscriptions/'">[[entry.organization.printable_name]]</a>
            </td>
            <td>[[entry.created_at | formatDate('MMM D, Y')]]</td>
            <td>[[entry.ends_at | formatDate('MMM D, Y')]]</td>
            <td class="description editable">
                <span v-show="!entry.edit_description" @click="editDescription(entry, group[0].plan.slug)">
                    [[entry.description]] <i class="fa fa-pencil"></i>
                </span>
                <input v-show="entry.edit_description" type="text"
                       class="form-control"
                       @blur="saveDescription(entry)"
                       @keyup.13="saveDescription(entry)"
                       v-model="entry.description"
                       :ref="refId(entry, group[0].plan.slug)"
                       tooltip="Edit description here"
                       tooltip-trigger="focus"
                       tooltip-placement="top">
            </td>
        </tr>
    </tbody>
    <tbody class="has-results"
           ng-repeat="entry in {{tab.slug}}.results | groupBy:['created_at']"
           ng-show="params.o === 'created_at'" ng-cloak
           v-for="(group, top_i) in groupBy({{tab.slug}}.results, 'created_at')"
           v-show="params.o === 'created_at'" v-cloak>
        <tr ng-show="entry.created_at_CHANGED">
            <td colspan="5">
                [[group[0].created_at | formatDate('MMM D, Y')]]
            </td>
        </tr>
        <tr v-for="(entry, index) in group" :class="endsSoon(entry)">
            <td></td>
            <td>
                <a :href="'{{urls.organization.profile_base}}' + entry.organization.slug + '/subscriptions/'">[[entry.organization.printable_name]]</a>
            </td>
            <td>[[entry.plan.title]]</td>
            <td>[[entry.ends_at | formatDate('MMM D, Y')]]</td>
            <td class="description editable">
                <span v-show="!entry.edit_description" @click="editDescription(entry, group[0].created_at)">
                    [[entry.description]] <i class="fa fa-pencil"></i>
                </span>
                <input v-show="entry.edit_description" type="text"
                       class="form-control"
                       @blur="saveDescription(entry)"
                       @keyup.13="saveDescription(entry)"
                       v-model="entry.description"
                       :ref="refId(entry, group[0].created_at)"
                       tooltip="Edit description here"
                       tooltip-trigger="focus"
                       tooltip-placement="top">
            </td>
        </tr>
    </tbody>
    <tbody ng-repeat="entry in {{tab.slug}}.results | groupBy:['ends_at']"
           ng-show="params.o === 'ends_at'" ng-cloak
           v-for="(group, key) in groupBy({{tab.slug}}.results, 'ends_at')"
           v-show="params.o === 'ends_at'" v-cloak>
        <tr ng-show="entry.ends_at_CHANGED">
            <td colspan="5">
                [[group[0].ends_at | formatDate('MMM D, Y')]]
            </td>
        </tr>
        <tr v-for="entry in group" :class="endsSoon(entry)">
            <td></td>
            <td>
                <a :href="'{{urls.organization.profile_base}}' + entry.organization.slug + '/subscriptions/'">[[entry.organization.printable_name]]</a>
            </td>
            <td>[[entry.plan.title]]</td>
            <td>[[entry.created_at | formatDate('MMM D, Y')]]</td>
            <td class="description editable">
                <span v-show="!entry.edit_description" @click="editDescription(entry, group[0].ends_at)">
                    [[entry.description]] <i class="fa fa-pencil"></i>
                </span>
                <input v-show="entry.edit_description" type="text"
                       class="form-control"
                       @blur="saveDescription(entry)"
                       @keyup.13="saveDescription(entry)"
                       v-model="entry.description"
                       :ref="refId(entry, group[0].ends_at)"
                       tooltip="Edit description here"
                       tooltip-trigger="focus"
                       tooltip-placement="top">
            </td>
        </tr>
    </tbody>
</table>
</div>
<div class="text-center" v-show="{{tab.slug}}.loaded && totalItems > itemsPerPage">
    <uiv-pagination v-model="params.page" :total-page="pageCount" @change="get" size="sm" boundary-links/>
</div>
            </tab>
        {% endfor %}
    </tabs>
</div>
<div>
    <a id="new-subscriber" class="btn btn-primary pull-right" href="{{urls.organization_create}}">New Billing Profile &raquo;</a>
</div>
</section>
{% endblock %}
